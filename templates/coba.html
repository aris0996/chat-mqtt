{% extends "base.html" %}

{% block title %}ARS CHAT ROOM{% endblock %}

{% block header %}
<div class="header-container">
    <h1>ARS CHAT ROOM</h1>
    <div class="call-container">
        <button id="startCall" onclick="startCall()">Mulai Panggilan</button>
        <button id="endCall" onclick="endCall()" style="display: none;">Akhiri Panggilan</button>
    </div>
</div>
{% endblock %}

{% block content %}
    <div class="chat-container" id="chat-container"></div>
    <div class="input-id-container" id="inputId" style="display: none;">
        <input type="text" id="subscribeTopicInput" placeholder="Masukkan ID Anda">
        <input type="text" id="topicInput" placeholder="Masukkan Tujuan">
        <button class="button-ok" onclick="subscribeTopic()">OK</button>
    </div>
    <div class="input-container">
        <input type="text" id="messageInput" placeholder="Masukkan Pesan">
        <span class="send-icon" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></span>
        <span class="key-icon" onclick="toggleInputId()">ðŸ”‘</span>
        <label for="fileInput" class="file-label"><i class="fas fa-paperclip"></i></label>
        <input type="file" id="fileInput" accept="image/*" onchange="sendImage()">
        <span class="mic-icon" onclick="toggleRecording()"><i class="fas fa-microphone"></i></span>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const broker = 'wss://broker.emqx.io:8084/mqtt';
        const client = mqtt.connect(broker);

        client.on('connect', () => {
            console.log('Connected to MQTT broker');
        });

        client.on('message', (receivedTopic, message) => {
            if (receivedTopic && receivedTopic !== client.options.clientId) {
                console.log('Received message:', receivedTopic, message.toString());
                try {
                    const parsedMessage = JSON.parse(message.toString());
                    if (parsedMessage.type === "audio") {
                        displayMessage(receivedTopic, `<audio controls src="${parsedMessage.url}"></audio>`);
                    } else {
                        displayMessage(receivedTopic, message.toString());
                    }
                } catch (e) {
                    displayMessage(receivedTopic, message.toString());
                }
            }
        });

        client.on('error', (error) => {
            console.error('Connection error:', error);
        });

        const socket = io({
            transports: ['polling', 'websocket'],
            upgrade: false
        });
        let localStream;
        let peerConnection;

        function toggleInputId() {
            const inputId = document.getElementById('inputId');
            inputId.style.display = inputId.style.display === 'none' ? 'flex' : 'none';
        }

        function subscribeTopic() {
            const subscribeTopic = document.getElementById('subscribeTopicInput').value.trim();
            if (subscribeTopic) {
                client.subscribe(subscribeTopic, (err) => {
                    if (!err) {
                        displayMessage('', `ID kamu terdaftar: ${subscribeTopic}`);
                        toggleInputId();
                    } else {
                        console.error('Subscription error:', err);
                        alert('Failed to subscribe to topic');
                    }
                });
            } else {
                alert('ID cannot be empty!');
            }
        }

        function sendMessage() {
            const topic = document.getElementById('topicInput').value.trim() || 'default/topic';
            const message = document.getElementById('messageInput').value.trim();
            if (message) {
                client.publish(topic, message);
                displayMessage(' ', message);
                console.log('Published message:', message);
                document.getElementById('messageInput').value = '';
                // Hapus baris berikut:
                // saveMessageToSheet(message);
            } else {
                alert('Pesan tidak boleh kosong!');
            }
        }

        function sendImage() {
            const topic = document.getElementById('topicInput').value.trim() || 'default/topic';
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64data = reader.result;
                    client.publish(topic, base64data);
                    displayMessage(' ', base64data);
                    console.log('Published image');
                    // Hapus baris berikut:
                    // saveMessageToSheet(base64data);
                };
                reader.readAsDataURL(file);
            }
        }

        function displayMessage(topic, message) {
            const chatContainer = document.getElementById('chat-container');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            if (topic === ' ' || topic === '  ') {
                messageElement.classList.add('sent');
                if (message.startsWith('data:image/')) {
                    messageElement.innerHTML = `<img src="${message}" alt="Image">`;
                } else if (message.startsWith('<audio')) {
                    messageElement.innerHTML = message;
                } else {
                    messageElement.innerHTML = `${message}`;
                }
            } else {
                messageElement.classList.add('received');
                if (message.startsWith('data:image/')) {
                    messageElement.innerHTML = `<img src="${message}" alt="Image">`;
                } else if (message.startsWith('<audio')) {
                    messageElement.innerHTML = message;
                } else {
                    messageElement.innerHTML = `${message}`;
                }
            }

            const timestamp = document.createElement('span');
            timestamp.classList.add('timestamp');
            timestamp.textContent = new Date().toLocaleTimeString();
            messageElement.appendChild(timestamp);

            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        let mediaRecorder;
        let audioChunks = [];

        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks);
                        sendAudio(audioBlob);
                        audioChunks = [];
                    });
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
        }

        function sendAudio(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob, "recording.wav");

            fetch("/upload_audio", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const topic = document.getElementById('topicInput').value.trim() || 'default/topic';
                    client.publish(topic, JSON.stringify({type: "audio", url: data.url}));
                    displayMessage(' ', `<audio controls src="${data.url}"></audio>`);
                } else {
                    console.error('Gagal mengunggah audio:', data.error);
                    alert('Gagal mengunggah audio. Silakan coba lagi.');
                }
            })
            .catch(error => {
                console.error('Error saat mengunggah audio:', error);
                alert('Terjadi kesalahan saat mengunggah audio. Silakan coba lagi.');
            });
        }

        function startCall() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                alert('Silakan masukkan alamat tujuan panggilan terlebih dahulu!');
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    document.getElementById('startCall').style.display = 'none';
                    document.getElementById('endCall').style.display = 'inline-block';
                    
                    const configuration = { 
                        'iceServers': [
                            { 'urls': 'stun:stun.l.google.com:19302' },
                            { 'urls': 'stun:stun1.l.google.com:19302' },
                            { 'urls': 'stun:stun2.l.google.com:19302' }
                        ] 
                    };
                    peerConnection = new RTCPeerConnection(configuration);
                    
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                    
                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            socket.emit('ice_candidate', { candidate: event.candidate, target: topic });
                        }
                    };
                    
                    peerConnection.ontrack = event => {
                        const remoteAudio = document.createElement('audio');
                        remoteAudio.srcObject = event.streams[0];
                        remoteAudio.autoplay = true;
                        document.body.appendChild(remoteAudio);
                    };
                    
                    socket.emit('call_request', { target: topic });
                })
                .catch(error => {
                    console.error('Error mengakses perangkat media:', error);
                    alert('Tidak dapat mengakses mikrofon. Pastikan Anda telah memberikan izin.');
                });
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('startCall').style.display = 'inline-block';
            document.getElementById('endCall').style.display = 'none';
        }

        socket.on('offer', data => {
            if (!peerConnection) {
                startCall();
            }
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    socket.emit('answer', { answer: peerConnection.localDescription, target: data.target });
                });
        });

        socket.on('answer', data => {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        });

        socket.on('ice_candidate', data => {
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });

        // Tambahkan fungsi baru untuk menangani panggilan masuk
        function handleIncomingCall(caller) {
            const ringtone = new Audio('/static/ringtone.mp3'); // Pastikan file ringtone.mp3 ada di folder static
            ringtone.loop = true;
            ringtone.play();

            const answer = confirm(`Panggilan masuk dari ${caller}. Terima panggilan?`);
            ringtone.pause();

            if (answer) {
                // Terima panggilan
                socket.emit('call_accepted', { target: caller });
                startCall();
            } else {
                // Tolak panggilan
                socket.emit('call_rejected', { target: caller });
            }
        }

        // Tambahkan event listener untuk panggilan masuk
        socket.on('incoming_call', (data) => {
            handleIncomingCall(data.caller);
        });

        // Tambahkan event listener untuk panggilan diterima
        socket.on('call_accepted', () => {
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.emit('offer', { offer: peerConnection.localDescription, target: document.getElementById('topicInput').value.trim() });
                })
                .catch(error => {
                    console.error('Error saat membuat tawaran:', error);
                    alert('Terjadi kesalahan saat memulai panggilan. Silakan coba lagi.');
                });
        });

        socket.on('call_rejected', () => {
            alert('Panggilan ditolak.');
            endCall();
        });
    </script>
{% endblock %}
