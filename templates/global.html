{% extends "base.html" %}

{% block title %}Global Chat Room{% endblock %}

{% block header %}
<div class="header-container">
    <h1>Global Chat Room</h1>
    <nav class="nav-menu">
        <a href="/" class="nav-link">Global Chat</a>
        <a href="/coba" class="nav-link">Private Chat</a>
        <button id="logoutBtn" onclick="handleLogout()" style="display: none;" class="nav-link">Keluar Room</button>
    </nav>
</div>
{% endblock %}

{% block content %}
<div id="login-container">
    <input type="text" id="usernameInput" placeholder="Masukkan username Anda">
    <button onclick="registerUser()">Masuk</button>
</div>

<div id="chat-section" style="display: none;">
    <div class="chat-container" id="chat-container"></div>
    <div class="input-container">
        <input type="text" id="messageInput" placeholder="Masukkan Pesan">
        <span class="send-icon" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></span>
        <label for="fileInput" class="file-label"><i class="fas fa-paperclip"></i></label>
        <input type="file" id="fileInput" accept="image/*" onchange="sendImage()">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    let currentUsername = '';
    let deviceId = localStorage.getItem('deviceId') || generateDeviceId();

    function generateDeviceId() {
        const newDeviceId = 'device_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', newDeviceId);
        return newDeviceId;
    }

    async function registerUser() {
        const username = document.getElementById('usernameInput').value.trim();
        if (!username) {
            alert('Username tidak boleh kosong!');
            return;
        }

        try {
            const response = await fetch('/register_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    device_id: deviceId
                })
            });

            const data = await response.json();
            if (data.status === 'success') {
                currentUsername = data.username;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('chat-section').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                loadMessages();
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mendaftar');
        }
    }

    async function loadMessages() {
        try {
            const response = await fetch('/get_messages');
            const messages = await response.json();
            messages.forEach(msg => displayMessage(msg));
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    function sendMessage() {
        const message = document.getElementById('messageInput').value.trim();
        if (message) {
            socket.emit('send_message', {
                username: currentUsername,
                message: message,
                type: 'text'
            });
            document.getElementById('messageInput').value = '';
        }
    }

    function sendImage() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                socket.emit('send_message', {
                    username: currentUsername,
                    message: reader.result,
                    type: 'image'
                });
            };
            reader.readAsDataURL(file);
        }
    }

    function displayMessage(data) {
        const chatContainer = document.getElementById('chat-container');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        messageElement.classList.add(data.username === currentUsername ? 'sent' : 'received');

        if (data.type === 'image') {
            messageElement.innerHTML = `
                <span class="username">${data.username}</span>
                <img src="${data.message}" alt="Image">
                <span class="timestamp">${data.timestamp}</span>
            `;
        } else {
            messageElement.innerHTML = `
                <span class="username">${data.username}</span>
                <span class="content">${data.message}</span>
                <span class="timestamp">${data.timestamp}</span>
            `;
        }

        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    socket.on('new_message', displayMessage);

    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function handleLogout() {
        currentUsername = '';
        document.getElementById('login-container').style.display = 'block';
        document.getElementById('chat-section').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('chat-container').innerHTML = '';
        document.getElementById('usernameInput').value = '';
        socket.emit('leave', { username: currentUsername, room: 'global' });
    }
</script>
{% endblock %}
