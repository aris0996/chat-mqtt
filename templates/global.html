{% extends "base.html" %}

{% block title %}Global Chat Room{% endblock %}

{% block content %}
<!-- Login Modal -->
<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2>Selamat Datang di Global Chat</h2>
        <div class="modal-input-group">
            <input type="text" id="usernameInput" placeholder="Masukkan username Anda">
            <i class="fas fa-user"></i>
        </div>
        <button class="modal-button" onclick="joinGlobalChat()">
            <i class="fas fa-sign-in-alt"></i>
            Masuk ke Chat
        </button>
    </div>
</div>

<!-- Chat Container -->
<div class="global-chat-container" style="display: none;">
    <!-- Header global chat -->
    <div class="chat-header-container">
        <div class="chat-header">
            <div class="header-left">
                <a href="/" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div class="header-info">
                    <h3>Global Chat Room</h3>
                    <span class="online-users">
                        <i class="fas fa-circle online-indicator"></i>
                        <span id="onlineCount">0</span> Pengguna Online
                    </span>
                </div>
            </div>
            <div class="header-right">
                <span class="header-icon">
                    <i class="fas fa-users"></i>
                </span>
            </div>
        </div>
    </div>
    
    <!-- Chat messages container -->
    <div class="chat-container" id="globalChatContainer"></div>
    
    <!-- Context menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="replyToMessage()">
            <i class="fas fa-reply"></i> Balas
        </div>
    </div>

    <!-- Input container -->
    <div class="input-container">
        <div id="replyPreview" style="display: none;" class="reply-container">
            <span class="reply-close" onclick="cancelReply()">Ã—</span>
            <div class="reply-text" id="replyText"></div>
        </div>
        <input type="text" id="messageInput" placeholder="Ketik pesan..." onkeypress="checkEnter(event)">
        <label for="fileInput" class="file-label">
            <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="fileInput" accept="image/*" onchange="sendImage()" style="display: none;">
        <span class="send-icon" onclick="sendGlobalMessage()">
            <i class="fas fa-paper-plane"></i>
        </span>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="image-preview-modal" id="imagePreviewModal">
    <div class="image-preview-content">
        <span class="preview-close" onclick="closeImagePreview()">Ã—</span>
        <img id="previewImage" class="preview-image" src="" alt="Preview">
        <div class="image-preview-actions">
            <button class="preview-button" onclick="downloadImage()">
                <i class="fas fa-download"></i>
                Unduh Gambar
            </button>
            <button class="preview-button" onclick="closeImagePreview()">
                <i class="fas fa-times"></i>
                Tutup
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
let currentUsername = '';
let selectedMessageId = null;
let replyingTo = null;
let selectedMessageType = null;

// Konfigurasi MQTT
const broker = 'wss://broker.emqx.io:8084/mqtt';
const client = mqtt.connect(broker);
const globalTopic = 'global_chat'; // Topic untuk global chat

// MQTT connection handlers
client.on('connect', () => {
    console.log('Connected to MQTT broker');
    client.subscribe(globalTopic, (err) => {
        if (!err) {
            console.log('Subscribed to global chat');
        }
    });
});

client.on('message', (topic, message) => {
    try {
        const data = JSON.parse(message.toString());
        displayMessage(data);
    } catch (e) {
        console.error('Error parsing message:', e);
    }
});

client.on('error', (error) => {
    console.error('MQTT error:', error);
});

// Update fungsi untuk menggunakan MQTT
function joinGlobalChat() {
    const username = document.getElementById('usernameInput').value.trim();
    if (username) {
        currentUsername = username;
        document.getElementById('loginModal').style.display = 'none';
        document.querySelector('.global-chat-container').style.display = 'block';
        
        // Kirim pesan join
        const joinMessage = {
            type: 'system',
            username: username,
            message: `ðŸ‘‹ ${username} bergabung ke chat`
        };
        client.publish(globalTopic, JSON.stringify(joinMessage));
    } else {
        alert('Username tidak boleh kosong!');
    }
}

function sendGlobalMessage() {
    const message = document.getElementById('messageInput').value.trim();
    if (message && currentUsername) {
        const messageData = {
            username: currentUsername,
            message: message,
            type: 'text',
            replyTo: selectedMessageId,
            replyType: selectedMessageType,
            replyToText: replyingTo,
            timestamp: new Date().toISOString()
        };
        client.publish(globalTopic, JSON.stringify(messageData));
        document.getElementById('messageInput').value = '';
        cancelReply();
    }
}

function sendImage() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (file && currentUsername) {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64data = reader.result;
            const messageData = {
                username: currentUsername,
                message: base64data,
                type: 'image',
                replyTo: selectedMessageId,
                replyType: selectedMessageType,
                replyToText: replyingTo,
                timestamp: new Date().toISOString()
            };
            client.publish(globalTopic, JSON.stringify(messageData));
            cancelReply();
        };
        reader.readAsDataURL(file);
    }
}

// Tambahkan event listener untuk disconnect
window.addEventListener('beforeunload', () => {
    if (currentUsername) {
        const leaveMessage = {
            type: 'system',
            username: currentUsername,
            message: `ðŸ‘‹ ${currentUsername} meninggalkan chat`
        };
        client.publish(globalTopic, JSON.stringify(leaveMessage));
        client.end();
    }
});

function displayMessage(data) {
    const chatContainer = document.getElementById('globalChatContainer');
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    
    // Jika pesan sistem, update jumlah user online jika ada
    if (data.type === 'system') {
        messageElement.classList.add('system');
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');
        contentDiv.textContent = data.message;
        messageElement.appendChild(contentDiv);
        chatContainer.appendChild(messageElement);
        
        // Update jumlah user online jika ada perubahan
        if (data.onlineCount !== undefined) {
            updateOnlineCount(data.onlineCount);
        }
        
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return;
    }
    
    // Generate unique ID untuk pesan
    const messageId = 'msg_' + Date.now();
    messageElement.id = messageId;

    // Event listeners untuk context menu (hanya untuk pesan non-sistem)
    messageElement.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const messageText = data.type === 'image' ? data.message : data.message;
        showContextMenu(e, messageId, messageText, data.type);
    });

    // Event listener untuk long press
    let pressTimer;
    messageElement.addEventListener('touchstart', () => {
        pressTimer = setTimeout(() => {
            const messageText = data.type === 'image' ? data.message : data.message;
            showContextMenu(event, messageId, messageText, data.type);
        }, 500);
    });
    messageElement.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
    });

    // Pesan normal (teks atau gambar)
    messageElement.classList.add(data.username === currentUsername ? 'sent' : 'received');

    // Header dengan username dan timestamp
    const headerDiv = document.createElement('div');
    headerDiv.classList.add('message-header');
    
    const username = document.createElement('span');
    username.classList.add('username');
    username.textContent = data.username;
    
    const timestamp = document.createElement('span');
    timestamp.classList.add('timestamp');
    timestamp.textContent = new Date().toLocaleTimeString();
    
    headerDiv.appendChild(username);
    headerDiv.appendChild(timestamp);
    messageElement.appendChild(headerDiv);

    // Tambahkan reply preview jika ada
    if (data.replyToText) {
        const replyDiv = document.createElement('div');
        replyDiv.classList.add('message-reply-preview');
        
        const replyIcon = document.createElement('i');
        replyIcon.className = 'fas fa-reply';
        replyDiv.appendChild(replyIcon);
        
        // Jika yang direply adalah gambar
        if (data.replyType === 'image') {
            const replyImgContainer = document.createElement('div');
            replyImgContainer.classList.add('reply-image-container');
            
            const replyImg = document.createElement('img');
            replyImg.src = data.replyToText;
            replyImg.classList.add('reply-thumbnail');
            
            replyImgContainer.appendChild(replyImg);
            replyDiv.appendChild(replyImgContainer);
        } else {
            const replyText = document.createElement('span');
            replyText.textContent = data.replyToText;
            replyDiv.appendChild(replyText);
        }
        
        messageElement.appendChild(replyDiv);
    }

    // Content
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');
    
    if (data.type === 'image') {
        const imageContainer = document.createElement('div');
        imageContainer.classList.add('message-image-container');
        
        const img = document.createElement('img');
        img.src = data.message;
        img.classList.add('message-thumbnail');
        img.onclick = () => showImagePreview(data.message);
        
        imageContainer.appendChild(img);
        contentDiv.appendChild(imageContainer);
    } else {
        contentDiv.textContent = data.message;
    }

    messageElement.appendChild(contentDiv);
    chatContainer.appendChild(messageElement);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showImagePreview(src) {
    const modal = document.getElementById('imagePreviewModal');
    const previewImage = document.getElementById('previewImage');
    previewImage.src = src;
    modal.style.display = 'block';
}

function closeImagePreview() {
    document.getElementById('imagePreviewModal').style.display = 'none';
}

function downloadImage() {
    const image = document.getElementById('previewImage');
    const link = document.createElement('a');
    link.href = image.src;
    link.download = 'global-chat-image-' + new Date().getTime() + '.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function checkEnter(event) {
    if (event.key === 'Enter') {
        sendGlobalMessage();
    }
}

// Tambahkan event listener untuk context menu
document.addEventListener('click', () => {
    document.getElementById('contextMenu').style.display = 'none';
});

function showContextMenu(event, messageId, messageText, messageType) {
    event.preventDefault();
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'block';
    contextMenu.style.left = `${event.pageX}px`;
    contextMenu.style.top = `${event.pageY}px`;
    selectedMessageId = messageId;
    replyingTo = messageText;
    selectedMessageType = messageType;
}

function replyToMessage() {
    if (selectedMessageId && replyingTo) {
        const replyPreview = document.getElementById('replyPreview');
        const replyText = document.getElementById('replyText');
        replyPreview.style.display = 'block';
        
        // Clear previous content
        replyText.innerHTML = '';
        
        // Jika yang direply adalah gambar
        if (selectedMessageType === 'image') {
            const replyImgContainer = document.createElement('div');
            replyImgContainer.classList.add('reply-image-container');
            
            const replyImg = document.createElement('img');
            replyImg.src = replyingTo;
            replyImg.classList.add('reply-thumbnail');
            
            replyImgContainer.appendChild(replyImg);
            replyText.appendChild(replyImgContainer);
        } else {
            replyText.textContent = replyingTo;
        }
        
        document.getElementById('messageInput').focus();
    }
    document.getElementById('contextMenu').style.display = 'none';
}

function cancelReply() {
    document.getElementById('replyPreview').style.display = 'none';
    selectedMessageId = null;
    replyingTo = null;
    selectedMessageType = null;
}

// Tampilkan login modal saat halaman dimuat
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginModal').style.display = 'block';
});

// Tambahkan fungsi untuk menghitung user online
function updateOnlineCount(count) {
    document.getElementById('onlineCount').textContent = count || '0';
}
</script>

<style>
.global-chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: #fff;
}

#globalChatContainer {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #E5DDD5;
    background-image: url(static/img/bg.png);
}

.chat-header-container {
    padding: 0.5rem 1rem;
    background: #fff;
    border-bottom: 1px solid #ddd;
}

.input-container {
    padding: 1rem;
    background: #fff;
    border-top: 1px solid #ddd;
}

.reply-container {
    background: rgba(0, 0, 0, 0.05);
    padding: 8px 12px;
    border-left: 4px solid #128C7E;
    border-radius: 4px;
    margin-bottom: 5px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
}

.reply-text {
    flex: 1;
    display: flex;
    align-items: center;
}

.reply-image-container {
    max-width: 40px;
    max-height: 40px;
    overflow: hidden;
    border-radius: 4px;
    margin-right: 8px;
}

.reply-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.reply-close {
    cursor: pointer;
    color: #999;
    padding: 2px 5px;
    margin-left: 8px;
}

.reply-close:hover {
    color: #666;
}

.message-reply-preview {
    display: flex;
    align-items: center;
    background: rgba(0, 0, 0, 0.05);
    padding: 4px 8px;
    margin-bottom: 5px;
    border-left: 3px solid #128C7E;
    border-radius: 4px;
    font-size: 0.85rem;
}

.message-reply-preview i {
    color: #128C7E;
    font-size: 0.8rem;
    margin-right: 8px;
}

.message-reply-preview .reply-thumbnail {
    margin-left: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}
